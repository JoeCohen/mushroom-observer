#!/usr/bin/env ruby

require File.expand_path("../../config/boot.rb", __FILE__)
require File.expand_path("../../config/environment.rb", __FILE__)
require File.expand_path("../../app/extensions/extensions.rb", __FILE__)

user = User.find_by_login("Pulk")
old_name = Name.find(431)
new_name = Name.find(61758)
synonyms = old_name.synonyms
synonym_ids = synonyms.map(&:id)
user_wgts = {}

[
  [661, nil],
  [679, 2.57931],
  [2606, nil],
  [2621, nil],
  [4675, nil],
  [4714, nil],
  [6594, nil],
  [6683, nil],
  [7561, 2.70655],
  [9068, 1.63242],
  [9217, 1.69462],
  [10757, 0.0],
  [10915, 2.71314],
  [11137, 0.847965],
  [12712, 1.47708],
  [13152, -0.845668],
  [14221, 2.54049],
  [14772, 2.55959],
  [14966, 1.83815],
  [15213, 1.70019],
  [16899, 0.0],
  [17524, 2.47274],
  [17586, 1.73748],
  [17594, 0.82647],
  [18353, 1.70196],
  [19418, 1.67523],
  [20004, 2.44081],
  [20587, 1.7037],
  [21110, 1.73723],
  [21312, 2.3291],
  [21547, 1.67056],
  [21696, 1.57839],
  [23428, 1.31583],
  [24107, -0.0300309],
  [25792, 1.59789],
  [27259, 2.54877],
  [27760, 2.48163],
  [30135, 1.79787],
  [30648, 1.65149],
  [30857, 1.98482],
  [31094, 2.56471],
  [31818, 2.29193],
  [32003, 1.35052],
  [32662, 0.0],
  [45772, 2.52652],
  [45900, 2.54062],
  [46278, 2.43343],
  [46660, 1.71107],
  [48681, 1.70672],
  [50416, 2.42025],
  [52025, 2.46232],
  [56065, 1.76499],
  [56066, 2.55339],
  [56080, 1.60922],
  [56519, 1.62752],
  [58885, 1.7137],
  [60607, 2.51738],
  [61384, 1.66552],
  [63419, 1.71449],
  [63452, 2.10441],
  [65006, 2.47973],
  [65436, 1.71477],
  [67442, 2.70403],
  [67717, 2.33707],
  [74863, 1.63172],
  [74873, 0.796448],
  [75885, 2.53115],
  [76705, 2.52239],
  [76778, 1.70197],
  [77070, 1.71568],
  [79018, 2.55255],
  [79254, 1.67966],
  [79837, 2.5551],
  [80075, 1.7038],
  [80817, 0.826916],
  [80924, 2.70323],
  [81599, 1.66828],
  [82237, 0.0],
  [82763, 1.72897],
  [84273, 1.47228],
  [84906, 2.58998],
  [86094, 2.38374],
  [86759, 0.0],
  [86778, 1.5915],
  [87459, 1.21803],
  [91507, 1.67663],
  [92579, 2.56679],
  [93253, 2.59214],
  [93507, 2.56745],
  [95099, 2.19434],
  [95926, 1.36621],
  [96493, 2.1303],
  [96999, 1.68577],
  [97008, 1.68591],
  [97935, 1.64768],
  [98264, 1.72871],
  [99811, 0.862769],
  [102578, 2.46182],
  [103715, 1.65325],
  [103768, 0.857012],
  [104427, 2.5713],
  [106534, 1.35847],
  [108063, 2.52058],
  [114557, 2.57435],
  [114870, 1.5985],
  [116230, 1.58657],
  [116954, 2.56807],
  [118362, 2.52759],
  [121170, 1.34691],
  [122120, 2.40867],
  [128787, 2.58182],
  [129097, 0.762413],
  [131272, 1.72756],
  [132616, 1.81222],
  [132617, 2.46742],
  [132732, 1.6641],
  [132905, 1.65475],
  [133968, 1.69466],
  [135184, 2.44729],
  [135185, 1.83138],
  [135840, 1.69682],
  [135893, 1.68584],
  [136162, 0.828362],
  [136201, 0.726982],
  [137465, 0.84938],
  [137627, 2.59054],
  [138214, 0.852455],
  [138817, 1.68923],
  [139371, 1.71142],
  [141011, 0.816347],
  [141336, 1.71256],
  [141490, 0.813152],
  [142886, 2.56235],
  [143018, 2.4641],
  [143444, 2.55654],
  [145716, 2.57154],
  [147505, 2.56203],
  [148820, 2.39253],
  [150302, 1.63751],
  [150960, 0.829429],
  [151222, 1.73444],
  [151514, 2.08111],
  [151975, 2.53994],
  [152066, 2.54028],
  [152098, 2.58408],
  [153085, 2.54133],
  [153297, 2.537],
  [155439, 2.54326],
  [156340, 2.50555],
  [156854, 1.81621],
  [157231, 2.58749],
  [157269, 1.41434],
  [158555, 2.48113],
  [158970, 2.56788],
  [160995, 2.54014],
  [163504, 1.69525],
  [163985, 1.67034],
  [164200, 1.68857],
  [166289, 2.48836],
  [166416, 2.48842],
  [167280, 2.55885],
  [167702, 2.54383],
  [169200, 2.59051],
  [170136, 2.54809],
  [170269, 2.54845],
  [170817, 1.6842],
  [171352, 2.53934],
  [171672, 1.69311],
  [172663, 1.69859],
  [173049, 2.41982],
  [173960, 1.62502],
  [175478, 1.65232],
  [176304, 2.54505],
  [179530, 2.57343],
  [179541, 2.54519],
  [180757, 2.57386],
  [181174, 0.769397],
  [182205, 2.59229],
  [183321, 2.54975],
  [183500, 1.717],
  [184191, 2.55048],
  [184420, 2.55079],
  [184654, 1.71728],
  [184701, 2.55135],
  [186279, 2.50004],
  [186437, 2.50258],
  [187348, 1.71796],
  [188310, 2.54985],
  [189551, 2.73302],
  [189767, 2.55031],
  [189802, 1.60429],
  [190341, 2.55154],
  [191126, 2.55238],
  [193137, 2.44919],
  [193592, 2.55498],
  [194774, 2.55293],
  [194873, 2.55537],
  [194981, 2.55307],
  [195634, 2.55557],
  [195958, 2.55586],
  [196587, 2.25547],
  [196694, 0.844817],
  [197137, 2.55714],
  [197483, 2.55387],
  [197870, 2.55777],
  [198856, 1.83346],
  [201947, 2.53215],
  [203623, 1.55942],
  [204828, 1.58782],
  [205647, 2.59586],
  [206112, 1.67012],
  [207158, 2.47649],
  [208643, 1.64176],
  [214168, 0.83995],
  [215085, 1.61473],
  [215949, 2.55982],
  [216204, 1.83115],
  [216541, 1.73134],
  [218031, 2.56644],
  [219955, 2.56027],
  [221935, 1.62937],
  [223102, 1.64053],
  [226078, 1.7076],
  [226229, 2.47693],
  [226522, 2.60768],
  [229037, 2.53065],
  [229731, 2.56641],
  [234388, 0.792986],
  [235311, 2.59393],
  [238388, 1.69971],
  [239713, 2.48479],
  [240812, 1.73224],
  [241346, 0.83665],
  [242288, 1.69843],
  [242344, 2.59847],
  [244490, 1.73596],
  [244521, 1.73599],
  [245489, 2.50481],
  [245593, 1.70631],
  [246270, 2.59876],
  [246916, 2.60432],
  [248052, 0.812558],
  [248287, 2.24862],
  [249629, 1.6566],
  [254306, 2.59955],
  [254643, 2.52555],
  [255350, 2.5188],
  [257580, 1.80972],
  [257649, 1.35841],
  [258547, 2.59121],
  [258588, 2.53],
  [259031, 2.55407],
  [260153, 2.57898],
  [265432, 2.55209],
  [266781, 2.47682],
  [267593, 1.66229],
  [269645, 1.63849],
  [272102, 1.65547],
  [273280, 0.844366],
  [274481, 1.70669],
  [275359, 1.62409],
  [275673, 2.36703],
  [277986, 2.58972],
  [279234, 1.83625],
  [279623, 1.72685],
  [281092, 2.50315],
  [283132, 1.66483],
  [284025, 1.70979],
  [284482, 1.70986],
  [285481, 2.60066],
  [285876, 1.65187],
  [290285, 2.39369],
  [290506, 2.45061],
  [291469, 2.31766],
  [293127, 2.63729],
  [294228, 2.56558],
  [294716, 2.26456],
  [295370, 2.58964],
  [296388, 2.49262],
  [296444, 0.791488],
  [297212, 1.65784],
  [297479, 1.71569],
  [297748, 2.51168],
  [298545, 1.70199],
  [298806, 1.6696],
  [300913, 0.799451]
].each do |(id, old_score)|
  obs = Observation.safe_find(id)
  old_name = obs.name
  new_score = obs.vote_cache

  if !obs
    puts "Observation ##{id}: deleted!"
    next
  end

  # Get best vote for each user for this set of synonyms.
  votes = {}
  best_naming = nil
  obs.namings.each do |n|
    next unless synonym_ids.include?(n.name_id)
    n.votes.each do |v|
      uid = v.user_id
      val = v.value
      wgt = user_wgts[uid]
      wgt = user_wgts[uid] = v.user_weight if wgt.nil?
      if !votes[uid] || votes[uid][0] < val
        votes[uid] = [val, wgt]
        best_naming = n if uid == user.id
      end
    end
  end
  if !best_naming
    puts "Observation ##{id}: Pulk has no vote for old name!"
    next
  end

  # Combine votes.
  sum_val = 0
  sum_wgt = 0
  my_val, my_wgt = votes[user.id]
  votes.each do |uid, val_wgt|
    val, wgt = val_wgt
    next if uid == user.id
    sum_val += val * wgt
    sum_wgt += wgt
  end

  # Figure out how negative we have to be and still have new name win.
  did_it = false
  [1, -1, -2, -3].each do |val|
    if (sum_val + val * my_wgt).to_f / (sum_wgt + my_wgt + 1.0) < new_score
      if val == my_val
        puts "Observation ##{id}: leaving vote for old name at #{my_val}"
        did_it = true
        break
      end
      obs.change_vote(best_naming, val, user)
      if obs.reload.name == old_name
        puts "Observation ##{id}: changing vote for old name to #{val}"
        did_it = true
        break
      end
      puts "Observation ##{id}: tried changing vote for old name to #{val}, but it made the name change"
    end
  end
  if !did_it
    puts "Observation ##{id}: failed, leaving it alone!"
  end

  if obs.reload.name_id != new_name.id
    puts "Observation ##{id}: WRONG NAME: #{obs.name.search_name}"
  end
end
